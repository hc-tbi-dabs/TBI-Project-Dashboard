---
title: "Overview of TBI Investment Projects"
output: 
  pdf_document:
    latex_engine: xelatex
always_allow_html: yes
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{float}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{colortbl}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
---

```{r setup,include=FALSE,message=FALSE,warning=FALSE}
library(knitr)
library(kableExtra)
#' params$ip_selected
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
options(knitr.table.format='latex')
options(shiny.testmode = TRUE)
```


# Overall Portfolio: All Projects
### Report created on `r Sys.Date()`
The web dashboard can be found at [jodiqiao.shinyapps.io/tbi_dashboard](jodiqiao.shinyapps.io/tbi_dashboard).


### All Project Codes and Project Names
```{r}
title_628<-'628: Establishment Licensing and Inspections'
title_A03<-'A03: Enabling Compliance and Enforcement Program Delivery'
title_A04<-'A04: ROEB Aging IT (Stabilization/Modernization/Transformation)'

title_A05<-'A05: Drug and Health Product Inspections Database'
title_A06<-'A06: Modernizing the ROEB Employee eToolkit'
title_701<-'701: Border IM/IT Modernization'

title_704<-'704: Quality Management System'
title_705<-'705: DAS Modernization'
title_cyclops<-'Cyclops'

title_hummingbird<-'Hummingbird'
title_cipher<-'Cipher'
title_kelpie<-'Kelpie'

title_ip000<-'IP000: PCP IT Modernization'
```

- `r title_628`
- `r title_A03`
- `r title_A04`
- `r title_A05`
- `r title_A06`
- `r title_701`
- `r title_704`
- `r title_705`
- `r title_cyclops`
- `r title_hummingbird`
- `r title_kelpie`
- `r title_ip000`


### Overall Project Health Metadata
Project Health is evaluated by three components:

- Deliverability of functional elements
- Budget status
- Schedule

Out of 13 TBI projects with overall status information:
```{r}
num_del<-length(which(status$status == 'Delayed'))
num_cau<-length(which(status$status == 'Caution'))
num_ont<-length(which(status$status == 'On-Track'))

library(ggplot2)
library(emojifont)
df <- data.frame(
    x = rep(seq(2, 15, 6.5)),
    y = c(rep(6.5, 3)),
    h = rep(4.25, 3),
    w = rep(6.25, 3),
    value = c(num_del,
              num_cau,
              num_ont),
    info = c("Delayed",
             "Caution",
             "On-Track"),
    shape = c(fontawesome(search_fontawesome("chart")),
              emoji("none")),
    font_family = c(rep("fontawesome-webfont", 1),
                    "EmojiOne"),
    color = factor(1:3)
)

ggplot(df, aes(x, y, height = h, width = w, label = info)) +
    geom_tile(aes(fill = color)) +
    geom_text(color = "white", fontface = "bold", size = 10,
              aes(label = value, x = x - 2.9, y = y + 1), hjust = 0) +
    geom_text(color = "white", fontface = "bold",
              aes(label = info, x = x - 2.9, y = y - 1), hjust = 0) +
    coord_fixed() +
    scale_fill_brewer(type = "qual",palette = "Dark2") +
    geom_text(size = 20, aes(label = shape, family = font_family,
                             x = x + 1.5, y = y + 0.5), alpha = 0.25) +
    theme_void() +
    guides(fill = FALSE)
```
- `r num_del` delayed
- `r num_cau` caution
- `r num_ont` on-track

Out of 13 TBI projects with overall health information:
```{r}
num_red<-length(which(status$`Overall Project Health` == 'Red'))
num_yel<-length(which(status$`Overall Project Health` == 'Yellow'))
num_gre<-length(which(status$`Overall Project Health` == 'Green'))

library(ggplot2)
library(emojifont)
df <- data.frame(
    x = rep(seq(2, 15, 6.5)),
    y = c(rep(6.5, 3)),
    h = rep(4.25, 3),
    w = rep(6.25, 3),
    value = c(num_red,
              num_yel,
              num_gre),
    info = c("Red",
             "Yellow",
             "Green"),
    shape = c(fontawesome(search_fontawesome("chart")),
              emoji("none")),
    font_family = c(rep("fontawesome-webfont", 1),
                    "EmojiOne"),
    color = factor(1:6)
)

ggplot(df, aes(x, y, height = h, width = w, label = info)) +
    geom_tile(aes(fill = color)) +
    geom_text(color = "white", fontface = "bold", size = 10,
              aes(label = value, x = x - 2.9, y = y + 1), hjust = 0) +
    geom_text(color = "white", fontface = "bold",
              aes(label = info, x = x - 2.9, y = y - 1), hjust = 0) +
    coord_fixed() +
    scale_fill_brewer(type = "qual",palette = "Dark2") +
    geom_text(size = 20, aes(label = shape, family = font_family,
                             x = x + 1.5, y = y + 0.5), alpha = 0.25) +
    theme_void() +
    guides(fill = FALSE)
```
- `r num_red` red
- `r num_yel` yellow
- `r num_gre` green

\newpage
\blandscape

### Overall Project Budget Status
#### This bubble plot visualizes project budget health. The size of each circular area is relative to the size of the approved budget. The colors of these circles reflect project statuses where **Delayed** is red, **Caution** is yellow and **On-Track** is green.

```{r,message=FALSE,warning=FALSE, fig.width=10}

  status$IP2<-paste0(status$IP)
      status$IP2<-map(status$IP2,is.sf_proj)
      df<-status%>%
        filter(`Overall Project Health`!='Blue')%>%
        filter(IP %in% ip_selected()$ips)%>%
        left_join(budget[,c('IP','Approved Budget')])
      df$status<-factor(df$status,levels=c('On-Track','Caution','Delayed'))
      status_plot(df, "IP Projects")
```

#### Color code rules:

- Red: Significant course correction may be required. One or more of the intended project outputs may not be achieved. Identified changes may negatively impact the project's scope, cost or schedule and significant course correction may be required.
- Yellow: Some course correction may be required. One or more of the intended project outputs may not be achieved. Identified changes may negatively impact the project's scope, cost or schedule and some course correction may be required.
- Greem: The project is on track. The intended projet outputs are expected to be achieved. Identified changes are not expected to negatively impact the project's scope, cost or schedule.

\elandscape

\newpage
\blandscape

### Overall Project Stages & Project Status

```{r,fig.width=10}

  df<-all_proj%>%
        filter(IP %in% ip_selected()$ips)%>%
        group_by(stage,status)%>%
        summarise(IP=paste(IP,collapse='\n'),count=n())
      df$status<-factor(df$status,levels=c('On-Track','Caution','Delayed','Not yet started'))
      
  stage_plot(df)
```

\elandscape

\newpage
\blandscape

### Overall Budget Breakdown by Year

```{r, results='hide'}

  ds<-budget_yr%>%
      filter(IP %in% ip_selected()$ips)%>%
      #left_join(all_proj%>%select(IP=IP,internal_external=`Internal or External`))%>%
      group_by(Year,year,`Authority vs. Expenditures`)%>%
      summarise(Capital=sum(Capital,na.rm=T),
                Non_Capital=sum(Non_Capital,na.rm=T))
    
  #budget_plot(ds)
  
  p<-budget_plot(ds)%>%layout(height=500)
    
  # solution for plotly graphs not rendering in Rmarkdown PDF
  # tmpfile<-tempfile(fileext='.png')
  # export(p, file = "overall.png")
  # this doesn't work in shinyapps, but works in rstudio instance
```

```{r echo=FALSE,fig.align='center'}
# knitr::include_graphics("overall.png")
```

\elandscape

\newpage

### Overall Budget Projections
#### This horizontal bar chart shows all project forecasted expenditures for the ongoing fiscal year, forecasted total expenditures, expenditures to date and approved budget.

```{r,fig.width=10,fig.height=4}
  ds<-budget%>%
        filter(IP %in% ip_selected()$ips)%>%
        left_join(all_proj%>%select(IP=IP))%>%
        summarise(`Approved Budget`=sum(`Approved Budget`,na.rm=T),
                  `Expenditure to Date`=sum(`Expenditure to Date`,na.rm=T),
                  `Remaining Budget Projected`=sum(`Variance / Remaining budget`,na.rm=T))%>%
        gather(cat,value)
      
      budget_plot2(ds)
```

\newpage
\blandscape

### Overall Schedule
#### This timeplot shows all project tasks planned for the ongoing fiscal year, forecasted completion status and fiscal quarter. Completed tasks prior to the current fiscal year is hidden for simplicity. Only all tasks with complete milestone, approved finish date, actual finish date, and schedule health information will appear on the timeplot. If fewer datapoints are visualized than expected, the spreadsheet contains missing information.
```{r}
total_tasks<-nrow(schedule)
total_completed<-length(which(schedule$Schedule.Health.Standard == 'completed'))
total_incomplete<-length(which(schedule$Schedule.Health.Standard != 'completed'))
```

- All TBI tasks planned: `r total_tasks`
- Completed tasks: `r total_completed`
- Incomplete tasks: `r total_incomplete`

```{r,message=FALSE,warning=FALSE,results='hide',fig.width=12}

  df <- schedule %>%
    filter(!is.na(Approved_finish_date)) %>%
    filter(if(Schedule.Health.Standard == "completed"){Actual_date >= as.IDate(paste0(as.character(year(now())), "-01-01"))})
      # using schedule ommitted completed tasks because too crowded
      # only show tasks completed this year
  
      # shiny::validate((
      #   need(any(!is.na(df$Approved_finish_date)),'There is no information on project schedule')
      # ))
  
      incProgress(0.5)
  
      timeplot(df)

```  

\elandscape

\newpage

### Overall Budget Breakdown by Year Data Table

```{r}

  ds<-budget_yr%>%
        filter(IP %in% ip_selected()$ips)%>%
        group_by(Year,year,`Authority vs. Expenditures`)%>%
        summarise(capital=sum(Capital,na.rm=T),
                  non_capital=sum(Non_Capital,na.rm=T),
                  value=sum(Value,na.rm=T))%>%
        mutate_at(c('capital','non_capital','value'),dollar)
    
  knitr::kable(ds)

```

\newpage

### List of All Project Descriptions
```{r}
title_628<-'628: Establishment Licensing and Inspections'
title_A03<-'A03: Enabling Compliance and Enforcement Program Delivery'
title_A04<-'A04: ROEB Aging IT (Stabilization/Modernization/Transformation)'

title_A05<-'A05: Drug and Health Product Inspections Database'
title_A06<-'A06: Modernizing the ROEB Employee eToolkit'
title_701<-'701: Border IM/IT Modernization'

title_704<-'704: Quality Management System'
title_705<-'705: DAS Modernization'
title_cyclops<-'Cyclops'

title_hummingbird<-'Hummingbird'
title_cipher<-'Cipher'
title_kelpie<-'Kelpie'

title_ip000<-'IP000: PCP IT Modernization'
```

```{r}
project_628<-description$`Description`[description$IP=='628']
project_A03<-description$`Description`[description$IP=='A03']
project_A04<-description$`Description`[description$IP=='A04']

project_A05<-description$`Description`[description$IP=='A05']
project_A06<-description$`Description`[description$IP=='A06']
project_701<-description$`Description`[description$IP=='701']

project_704<-description$`Description`[description$IP=='704']
project_705<-description$`Description`[description$IP=='705']
project_cyclops<-description$`Description`[description$IP=='Cyclops']

project_hummingbird<-description$`Description`[description$IP=='Hummingbird']
project_cipher<-description$`Description`[description$IP=='Cipher']
project_kelpie<-description$`Description`[description$IP=='Kelpie']

project_ip000<-description$`Description`[description$IP=='IP000']
```

#### `r title_628` Descriptions
`r project_628`

#### `r title_A03` Descriptions
`r project_A03`

#### `r title_A04` Descriptions
`r project_A04`


#### `r title_A05` Descriptions
`r project_A05`

#### `r title_A06` Descriptions
`r project_A06`

#### `r title_701` Descriptions
`r project_701`


#### `r title_704` Descriptions
`r project_704`

#### `r title_705` Descriptions
`r project_705`

#### `r title_cyclops` Descriptions
`r project_cyclops`


#### `r title_hummingbird` Descriptions
`r project_hummingbird`

#### `r title_cipher` Descriptions
`r project_cipher`

#### `r title_kelpie` Descriptions
`r project_kelpie`


#### `r title_ip000` Descriptions
`r project_ip000`